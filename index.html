<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0, user-scalable=yes">
    <title>Snap&Print Studio</title>
    <link rel="apple-touch-icon" href="icon.png">
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.5.13/cropper.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Kanit:wght@300;400;500;600;700&display=swap');
        body { font-family: 'Kanit', sans-serif; background-color: #F2F2F7; touch-action: pan-y; }
        .glass-panel { background: rgba(255, 255, 255, 0.95); backdrop-filter: blur(10px); border-radius: 20px; box-shadow: 0 4px 6px rgba(0,0,0,0.05); }
        
        #eraser-container { position: relative; width: 100%; height: 55vh; overflow: hidden; border-radius: 12px; background: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABAAAAAQCAYAAAAf8/9hAAAAMUlEQVQ4T2NkYNgfQMQgA2AklBwwiCEg0EhmGBqO0QxiwMhgNBwNx2gGDA8D1pAEAgA59xcBfR/hCQAAAABJRU5ErkJggg==') repeat; border: 1px solid #d1d5db; touch-action: none; }
        #eraser-canvas { position: absolute; top: 0; left: 0; transform-origin: 0 0; }

        .cropper-container { width: 100%; height: 50vh; border-radius: 12px; overflow: hidden; background-color: #e5e7eb; position: relative; }
        .cropper-view-box { outline: 2px solid rgba(255,255,255,0.8); }
        .cropper-dashed { border-color: rgba(255,255,255,0.5); }

        #smart-guide { position: absolute; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; z-index: 10; display: flex; flex-direction: column; align-items: center; justify-content: center; opacity: 0.6; transition: opacity 0.3s; }
        .guide-head { width: 60%; height: 70%; border: 2px dashed #00FF00; border-radius: 50% 50% 40% 40%; position: relative; }
        .guide-eyes { position: absolute; top: 45%; left: 0; width: 100%; border-top: 1px solid #00FF00; }
        .guide-chin { position: absolute; bottom: 0; left: 0; width: 100%; border-top: 1px solid #00FF00; }

        .watermark-wrapper { position: relative; display: inline-block; width: 100%; overflow: hidden; border-radius: 12px; }
        .watermark-overlay {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; z-index: 20;
            background-image: url("data:image/svg+xml;utf8,<svg xmlns='http://www.w3.org/2000/svg' width='150' height='150'><text x='10' y='75' font-size='16' font-family='Kanit, sans-serif' font-weight='bold' fill='rgba(156, 163, 175, 0.4)' transform='rotate(-30, 75, 75)'>PREVIEW ONLY</text></svg>");
            background-repeat: repeat;
        }

        @media print {
            body * { visibility: hidden; }
            #print-area, #print-area * { visibility: visible; }
            #print-area { position: absolute; left: 0; top: 0; width: 100%; }
            @page { margin: 0; }
            header, .sticky, #loadingOverlay { display: none !important; }
            .watermark-wrapper::after, .watermark-overlay { display: none !important; }
        }
        
        input[type=range] { -webkit-appearance: none; width: 100%; background: transparent; }
        input[type=range]::-webkit-slider-thumb { -webkit-appearance: none; height: 24px; width: 24px; border-radius: 50%; background: #ffffff; box-shadow: 0 2px 6px rgba(0,0,0,0.3); margin-top: -10px; cursor: pointer; border: 1px solid #e5e7eb; }
        input[type=range]::-webkit-slider-runnable-track { width: 100%; height: 4px; cursor: pointer; background: #E5E5EA; border-radius: 2px; }
        .color-btn { width: 36px; height: 36px; border-radius: 50%; border: 2px solid transparent; cursor: pointer; transition: 0.2s; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
        .color-btn.active { border-color: #2563eb; transform: scale(1.1); box-shadow: 0 0 0 2px white, 0 0 0 4px #2563eb; }
        .sticky-action-bar { margin-top: -1.25rem; border-top-left-radius: 20px; border-top-right-radius: 20px; }

        .spinner { border: 4px solid #e5e7eb; border-top: 4px solid #3b82f6; border-radius: 50%; width: 40px; height: 40px; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    </style>
</head>
<body class="text-gray-800 antialiased pt-20 pb-20 px-4 md:px-12 max-w-3xl mx-auto">

    <div id="loadingOverlay" class="hidden fixed inset-0 bg-white/95 z-[100] flex-col items-center justify-center backdrop-blur-sm">
        <div class="spinner mb-4"></div>
        <h2 id="loadingText" class="text-lg font-bold text-blue-600">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£...</h2>
    </div>

    <header class="fixed top-0 left-0 w-full h-16 bg-white/95 backdrop-blur-md border-b border-gray-200 z-50 shadow-sm flex items-center">
        <div class="w-full max-w-3xl mx-auto px-4 md:px-12 flex justify-between items-center">
            <div class="flex items-center">
                <h1 class="text-xl font-bold text-blue-600 tracking-tight flex items-baseline">
                    <svg class="w-6 h-6 mr-1.5 self-center" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 9a2 2 0 012-2h.93a2 2 0 001.664-.89l.812-1.22A2 2 0 0110.07 4h3.86a2 2 0 011.664.89l.812 1.22A2 2 0 0018.07 7H19a2 2 0 012 2v9a2 2 0 01-2 2H5a2 2 0 01-2-2V9z"></path><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 13a3 3 0 11-6 0 3 3 0 016 0z"></path></svg>
                    Snap&Print <span class="text-[11px] text-gray-400 font-normal ml-2 tracking-normal">V.5</span>
                </h1>
                <span id="networkStatus" class="ml-3 px-2 py-0.5 text-[10px] font-bold rounded-full bg-green-100 text-green-700 border border-green-200 shadow-sm">
                    üü¢ ‡∏≠‡∏≠‡∏ô‡πÑ‡∏•‡∏ô‡πå
                </span>
            </div>
            <div class="flex gap-2">
                <button id="viewSummaryBtn" class="text-sm bg-blue-50 text-blue-600 border border-blue-200 px-3 py-1.5 rounded-lg font-bold shadow-sm active:bg-blue-100 transition flex items-center">
                    üìä ‡∏¢‡∏≠‡∏î‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ
                </button>
                <button id="globalRestartBtn" class="text-sm bg-red-50 text-red-600 border border-red-200 px-3 py-1.5 rounded-lg font-bold shadow-sm active:bg-red-100 transition">
                    ‡πÄ‡∏£‡∏¥‡πà‡∏°‡πÉ‡∏´‡∏°‡πà
                </button>
            </div>
        </div>
    </header>

    <div id="summaryModal" class="hidden fixed inset-0 bg-black/50 z-[60] flex items-center justify-center p-4">
        <div class="bg-white rounded-2xl w-full max-w-sm p-6 shadow-2xl transform transition-all">
            <div class="flex justify-between items-center mb-4 border-b pb-2">
                <h3 class="text-xl font-bold text-gray-800">üìä ‡∏™‡∏£‡∏∏‡∏õ‡∏¢‡∏≠‡∏î‡∏Å‡∏≤‡∏£‡∏ó‡∏≥‡∏á‡∏≤‡∏ô‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ</h3>
                <button id="closeSummaryBtn" class="text-gray-400 hover:text-red-500"><svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg></button>
            </div>
            <div id="summaryContent" class="space-y-3">
                <p class="text-center text-gray-500 my-4 text-sm">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•...</p>
            </div>
        </div>
    </div>

    <div id="step1-section" class="glass-panel p-5 mb-6">
        <div class="mb-4" id="uploadArea">
            <label class="block mb-2 font-medium text-lg text-gray-700">1. ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤ (‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î‡∏£‡∏π‡∏õ)</label>
            <div class="relative border-2 border-dashed border-blue-300 rounded-2xl bg-blue-50 hover:bg-blue-100 transition p-10 text-center cursor-pointer shadow-inner">
                <input type="file" id="imageInput" accept="image/*" class="absolute inset-0 w-full h-full opacity-0 cursor-pointer">
                <svg class="mx-auto h-12 w-12 text-blue-500" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-8l-4-4m0 0L8 8m4-4v12"></path></svg>
                <p class="mt-3 text-sm text-gray-700 font-medium">‡πÅ‡∏ï‡∏∞‡∏´‡∏£‡∏∑‡∏≠‡∏•‡∏≤‡∏Å‡πÑ‡∏ü‡∏•‡πå‡∏°‡∏≤‡∏ß‡∏≤‡∏á‡∏ó‡∏µ‡πà‡∏ô‡∏µ‡πà</p>
            </div>
        </div>

        <div id="eraser-workspace" class="hidden mt-6">
            <div class="sticky top-16 z-40 bg-white/95 backdrop-blur-md -mx-5 px-5 py-4 mb-5 border-b border-gray-200 shadow-sm sticky-action-bar">
                <button id="toStep2Btn" class="w-full bg-blue-600 active:bg-blue-700 text-white font-bold p-3.5 rounded-xl shadow-lg flex justify-center items-center text-[15px] transition-transform active:scale-95">
                    ‡πÑ‡∏õ‡∏ï‡∏±‡∏î‡∏Å‡∏£‡∏≠‡∏ö & ‡∏õ‡∏£‡∏±‡∏ö‡∏ú‡∏¥‡∏ß‡πÄ‡∏ô‡∏µ‡∏¢‡∏ô <svg class="w-5 h-5 ml-2" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M14 5l7 7m0 0l-7 7m7-7H3"></path></svg>
                </button>
            </div>

            <label class="block font-medium mb-2 text-gray-700">2. ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏û‡∏∑‡πâ‡∏ô‡∏´‡∏•‡∏±‡∏á</label>
            <div class="bg-gray-50 p-3 rounded-xl mb-4 border border-gray-200">
                <div class="flex justify-between items-center mb-3">
                    <button id="toggleEraserBtn" class="bg-white border border-gray-300 text-gray-700 px-4 py-2 rounded-lg font-medium shadow-sm flex items-center transition active:scale-95">
                        <svg class="w-5 h-5 mr-1 text-gray-500" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.232 5.232l3.536 3.536m-2.036-5.036a2.5 2.5 0 113.536 3.536L6.5 21.036H3v-3.572L16.732 3.732z"></path></svg> 
                        <span id="toggleEraserText">‡πÄ‡∏õ‡∏¥‡∏î‡∏¢‡∏≤‡∏á‡∏•‡∏ö</span>
                    </button>
                    <div class="flex space-x-2">
                        <button id="undoBtn" class="text-sm bg-gray-200 hover:bg-gray-300 px-3 py-2 rounded-lg flex items-center text-gray-600"><svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 10h10a8 8 0 018 8v2M3 10l6 6m-6-6l6-6"></path></svg></button>
                        <button id="redoBtn" class="text-sm bg-gray-200 hover:bg-gray-300 px-3 py-2 rounded-lg flex items-center text-gray-600"><svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24" style="transform: scaleX(-1);"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 10h10a8 8 0 018 8v2M3 10l6 6m-6-6l6-6"></path></svg></button>
                    </div>
                </div>
                <div class="grid grid-cols-2 gap-4">
                    <div><span class="text-xs text-gray-600 block mb-1">‡∏´‡∏±‡∏ß‡∏¢‡∏≤‡∏á‡∏•‡∏ö</span><input type="range" id="brushSize" min="10" max="200" value="60"></div>
                    <div><span class="text-xs text-blue-600 block mb-1 font-medium">‡∏Ç‡∏≠‡∏ö‡∏ô‡∏∏‡πà‡∏°</span><input type="range" id="brushSoftness" min="0" max="50" value="10"></div>
                </div>
            </div>

            <div class="flex justify-between items-center mb-1">
                <p class="text-sm text-gray-500">‡∏û‡∏∑‡πâ‡∏ô‡∏ó‡∏µ‡πà‡∏•‡∏ö</p>
                <button id="fitCanvasBtn" class="text-xs bg-blue-100 text-blue-700 px-3 py-1 rounded-lg font-medium shadow-sm">‡∏à‡∏±‡∏î‡∏†‡∏≤‡∏û‡∏û‡∏≠‡∏î‡∏µ‡∏à‡∏≠</button>
            </div>
            <div id="eraser-container" class="mb-4">
                <canvas id="eraser-canvas"></canvas>
            </div>

            <div class="mb-4">
                <label class="block mb-2 text-sm text-gray-600 font-medium">3. ‡∏™‡∏µ‡∏û‡∏∑‡πâ‡∏ô‡∏´‡∏•‡∏±‡∏á</label>
                <div class="flex flex-wrap gap-3 p-2 bg-gray-50 rounded-xl border border-gray-200 justify-center items-center" id="color-picker">
                    <div class="color-btn active" data-color="#FFFFFF" style="background-color: #FFFFFF; border: 1px solid #ccc;"></div>
                    <div class="color-btn" data-color="#1E3A8A" style="background-color: #1E3A8A;"></div> 
                    <div class="color-btn" data-color="#3B82F6" style="background-color: #3B82F6;"></div> 
                    <div class="color-btn" data-color="#DC2626" style="background-color: #DC2626;"></div> 
                    <div class="color-btn" data-color="#E5E7EB" style="background-color: #E5E7EB; border: 1px solid #ccc;"></div> 
                    <div class="flex items-center ml-2 pl-3 border-l border-gray-300">
                        <input type="color" id="customColorPicker" value="#000000" class="w-8 h-8 rounded cursor-pointer border-0 p-0 shadow-sm">
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div id="step2-section" class="glass-panel p-5 mb-6 hidden">
        <div class="sticky top-16 z-40 bg-white/95 backdrop-blur-md -mx-5 px-5 py-4 mb-5 border-b border-gray-200 shadow-sm flex gap-3 sticky-action-bar">
            <button id="backToStep1Btn" class="w-1/3 bg-gray-100 active:bg-gray-200 text-gray-700 font-bold p-3 rounded-xl text-sm border border-gray-200">‡∏Å‡∏•‡∏±‡∏ö</button>
            <button id="generateBtn" class="w-2/3 bg-green-500 active:bg-green-600 text-white font-bold p-3 rounded-xl shadow-lg transition text-[15px] active:scale-95">
                ‡∏õ‡∏£‡∏∞‡∏°‡∏ß‡∏•‡∏ú‡∏•‡∏£‡∏π‡∏õ <svg class="w-4 h-4 inline-block ml-1" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path></svg>
            </button>
        </div>

        <h2 class="font-bold text-lg mb-4 text-gray-800">4. ‡∏ï‡∏±‡∏î‡∏Å‡∏£‡∏≠‡∏ö & ‡∏£‡∏µ‡∏ó‡∏±‡∏ä‡πÉ‡∏ö‡∏´‡∏ô‡πâ‡∏≤</h2>

        <div class="mb-4 bg-gray-50 p-4 rounded-xl border border-gray-200 shadow-inner">
            <div class="grid grid-cols-2 gap-x-4 gap-y-3">
                <div class="flex flex-col"><span class="text-xs text-gray-500 font-medium">‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏ß‡πà‡∏≤‡∏á</span><input type="range" id="brightness" min="50" max="150" value="100"></div>
                <div class="flex flex-col"><span class="text-xs text-gray-500 font-medium">‡∏Ñ‡∏ß‡∏≤‡∏°‡∏Ñ‡∏°‡∏ä‡∏±‡∏î</span><input type="range" id="contrast" min="50" max="150" value="100"></div>
                <div class="flex flex-col"><span class="text-xs text-orange-500 font-medium">‡∏≠‡∏∏‡∏ì‡∏´‡∏†‡∏π‡∏°‡∏¥‡∏™‡∏µ</span><input type="range" id="temperature" min="-50" max="50" value="0"></div>
                <div class="flex flex-col"><span class="text-xs text-pink-500 font-medium">‡∏ó‡∏≥‡∏ú‡∏¥‡∏ß‡πÄ‡∏ô‡∏µ‡∏¢‡∏ô</span><input type="range" id="softSkin" min="0" max="30" value="0"></div>
            </div>
            <div class="flex items-center mt-3 pt-3 border-t border-gray-200">
                <span class="text-xs text-blue-600 font-medium w-16">‡πÄ‡∏≠‡∏µ‡∏¢‡∏á‡∏£‡∏π‡∏õ</span>
                <input type="range" id="rotation" min="-20" max="20" step="0.1" value="0" class="flex-1 mx-2">
                <span id="rotationValue" class="text-xs text-gray-500 w-8 text-right font-medium">0¬∞</span>
            </div>
        </div>

        <div class="flex justify-between items-center mb-1">
            <label class="flex items-center text-sm font-medium text-indigo-600"><input type="checkbox" id="toggleGuide" checked class="mr-2 rounded text-indigo-600"> ‡πÄ‡∏õ‡∏¥‡∏î‡πÄ‡∏™‡πâ‡∏ô‡πÑ‡∏Å‡∏î‡πå</label>
            <button id="resetCropBtn" class="text-xs bg-gray-200 px-2 py-1 rounded">‡∏£‡∏µ‡πÄ‡∏ã‡πá‡∏ï‡∏†‡∏≤‡∏û</button>
        </div>
        
        <div class="cropper-wrapper rounded-xl mb-4 border border-gray-300 relative shadow-sm">
            <img id="image-to-crop" src="" alt="Picture" class="hidden max-w-full">
            <div id="smart-guide" class="cropper-view-box">
                <div class="guide-head"><div class="guide-eyes"></div><div class="guide-chin"></div></div>
            </div>
        </div>

        <div class="mb-4">
            <label class="block text-sm text-gray-600 mb-1 font-bold">‡∏Ç‡∏ô‡∏≤‡∏î‡∏ß‡∏µ‡∏ã‡πà‡∏≤</label>
            <select id="visaSize" class="w-full p-3 border border-gray-300 rounded-xl bg-white text-sm font-medium">
                <option value="4x6" data-width="4" data-height="6">4 x 6 ‡∏ã‡∏°. (‡∏°‡∏≤‡∏ï‡∏£‡∏ê‡∏≤‡∏ô‡πÑ‡∏ó‡∏¢)</option>
                <option value="3.5x4.5" data-width="3.5" data-height="4.5">3.5 x 4.5 ‡∏ã‡∏°. (‡πÄ‡∏ä‡∏á‡πÄ‡∏Å‡πâ‡∏ô / ‡∏û‡∏≤‡∏™‡∏õ‡∏≠‡∏£‡πå‡∏ï)</option>
                <option value="3x4" data-width="3" data-height="4">3 x 4 ‡∏ã‡∏°. (‡∏™‡∏°‡∏±‡∏Ñ‡∏£‡∏á‡∏≤‡∏ô‡∏ó‡∏±‡πà‡∏ß‡πÑ‡∏õ)</option>
                <option value="2.5x3.5" data-width="2.5" data-height="3.5">2.5 x 3.5 ‡∏ã‡∏°. (1 ‡∏ô‡∏¥‡πâ‡∏ß)</option>
                <option value="5.08x5.08" data-width="5.08" data-height="5.08">2 x 2 ‡∏ô‡∏¥‡πâ‡∏ß (‡∏ß‡∏µ‡∏ã‡πà‡∏≤‡∏≠‡πÄ‡∏°‡∏£‡∏¥‡∏Å‡∏≤)</option>
                <option value="custom">-- ‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡∏Ç‡∏ô‡∏≤‡∏î‡πÄ‡∏≠‡∏á --</option>
            </select>
            <div id="customSizeContainer" class="hidden grid grid-cols-2 gap-4 mt-2 bg-gray-100 p-3 rounded-lg border border-gray-200">
                <div><span class="text-xs text-gray-500 block">‡∏Å‡∏ß‡πâ‡∏≤‡∏á (‡∏ã‡∏°.)</span><input type="number" id="customWidth" value="4" step="0.1" class="w-full p-2 border rounded text-center"></div>
                <div><span class="text-xs text-gray-500 block">‡∏™‡∏π‡∏á (‡∏ã‡∏°.)</span><input type="number" id="customHeight" value="6" step="0.1" class="w-full p-2 border rounded text-center"></div>
            </div>
        </div>

        <div class="grid grid-cols-2 gap-4 mb-6">
            <div>
                <label class="block text-sm text-gray-600 mb-1">‡∏Ç‡∏ô‡∏≤‡∏î‡∏Å‡∏£‡∏∞‡∏î‡∏≤‡∏©</label>
                <select id="paperSize" class="w-full p-3 border border-gray-300 rounded-xl bg-white text-sm">
                    <option value="4x6inch" data-width="10.16" data-height="15.24">4 x 6 ‡∏ô‡∏¥‡πâ‡∏ß (Jumbo)</option>
                    <option value="A4" data-width="21" data-height="29.7">A4</option>
                </select>
            </div>
            <div>
                <label class="block text-sm text-gray-600 mb-1">‡πÄ‡∏™‡πâ‡∏ô‡∏ï‡∏±‡∏î‡∏Ç‡∏≠‡∏ö</label>
                <select id="borderStyle" class="w-full p-3 border border-gray-300 rounded-xl bg-white text-sm">
                    <option value="1">‡πÄ‡∏™‡πâ‡∏ô‡∏ö‡∏≤‡∏á (‡∏õ‡∏Å‡∏ï‡∏¥)</option>
                    <option value="2">‡πÄ‡∏™‡πâ‡∏ô‡∏´‡∏ô‡∏≤‡∏õ‡∏≤‡∏ô‡∏Å‡∏•‡∏≤‡∏á</option>
                    <option value="0">‡πÑ‡∏°‡πà‡πÉ‡∏™‡πà‡πÄ‡∏™‡πâ‡∏ô‡∏Ç‡∏≠‡∏ö</option>
                </select>
            </div>
        </div>
        <div class="mb-4">
            <label class="block text-sm text-gray-600 mb-1">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏Å‡πá‡∏≠‡∏õ‡∏õ‡∏µ‡πâ</label>
            <input type="number" id="copies" value="4" min="1" class="w-full p-3 border border-gray-300 rounded-xl bg-white text-lg text-center font-bold">
        </div>
    </div>

    <div id="preview-section" class="glass-panel p-5 hidden">
        <div class="sticky top-16 z-40 bg-white/95 backdrop-blur-md -mx-5 px-5 py-4 mb-5 border-b border-gray-200 shadow-sm sticky-action-bar">
            
            <div class="flex justify-between items-center mb-3">
                 <button id="backToStep2Btn" class="bg-gray-100 text-gray-700 font-bold px-4 py-2 rounded-xl text-sm border border-gray-200 active:bg-gray-200">
                    <svg class="w-4 h-4 inline-block mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"></path></svg> ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏£‡∏π‡∏õ
                </button>
                <span class="text-xs bg-blue-50 text-blue-500 font-mono px-2 py-1 rounded border border-blue-100" id="displayOrderId">‡∏£‡∏≠‡∏£‡∏´‡∏±‡∏™...</span>
            </div>

            <div class="grid grid-cols-2 gap-3">
                <button id="saveSingleBtn" class="bg-indigo-600 active:bg-indigo-700 text-white font-bold p-3.5 rounded-xl text-[15px] shadow-lg flex justify-center items-center">
                    <svg class="w-5 h-5 mr-1.5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4"></path></svg> ‡∏£‡∏π‡∏õ‡πÄ‡∏î‡∏µ‡πà‡∏¢‡∏ß
                </button>
                <button id="shareBtn" class="bg-green-500 active:bg-green-600 text-white font-bold p-3.5 rounded-xl text-[15px] shadow-lg flex justify-center items-center">
                    <svg class="w-5 h-5 mr-1.5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8.684 13.342C8.886 12.938 9 12.482 9 12c0-.482-.114-.938-.316-1.342m0 2.684a3 3 0 110-2.684m0 2.684l6.632 3.316m-6.632-6l6.632-3.316m0 0a3 3 0 105.367-2.684 3 3 0 00-5.367 2.684zm0 9.316a3 3 0 105.368 2.684 3 3 0 00-5.368-2.684z"></path></svg> ‡πÅ‡∏ä‡∏£‡πå‡πÅ‡∏ú‡πà‡∏ô‡∏£‡∏ß‡∏°
                </button>
            </div>
        </div>

        <div id="print-area" class="w-full flex flex-col items-center gap-4 bg-gray-200 p-4 rounded-xl overflow-x-auto mb-4 border border-gray-300"></div>
        <p id="calc-info" class="text-sm text-gray-600 mb-4 text-center bg-gray-100 p-2 rounded-lg font-medium border border-gray-200"></p>

        <div class="mb-4 bg-yellow-50 p-3 rounded-lg border border-yellow-200">
            <label class="block text-sm text-gray-800 mb-1 font-bold">‡∏Ñ‡∏ß‡∏≤‡∏°‡∏Ñ‡∏°‡∏ä‡∏±‡∏î</label>
            <select id="exportQuality" class="w-full p-2 border border-gray-300 rounded-lg bg-white text-sm font-medium">
                <option value="max">‡∏Ñ‡∏°‡∏ä‡∏±‡∏î‡∏™‡∏π‡∏á‡∏™‡∏∏‡∏î (Max Original Quality)</option>
                <option value="print">‡∏ä‡∏±‡∏î‡∏ï‡∏≤‡∏°‡∏Ç‡∏ô‡∏≤‡∏î‡∏Å‡∏£‡∏∞‡∏î‡∏≤‡∏© (300 DPI)</option>
            </select>
        </div>
        <div class="mb-6">
            <label class="block text-sm text-gray-600 mb-1 font-medium">‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö‡πÑ‡∏ü‡∏•‡πå (‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÄ‡∏ã‡∏ü‡πÅ‡∏ú‡πà‡∏ô‡∏£‡∏ß‡∏°)</label>
            <select id="exportFormat" class="w-full p-2 border border-gray-300 rounded-lg bg-white text-sm">
                <option value="jpeg">JPEG (.jpg)</option>
                <option value="png">PNG (.png)</option>
                <option value="pdf">PDF (.pdf)</option>
            </select>
        </div>

        <button id="downloadZipBtn" class="w-full bg-purple-600 active:bg-purple-700 text-white font-bold p-3 rounded-xl shadow flex justify-center items-center text-sm mb-4">
            <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4"></path></svg> ‡πÇ‡∏´‡∏•‡∏î‡πÅ‡∏û‡πá‡∏Å‡πÄ‡∏Å‡∏à (ZIP) <span class="ml-1 opacity-75 font-normal">‡πÅ‡∏ú‡πà‡∏ô+‡∏£‡∏π‡∏õ‡πÄ‡∏î‡∏µ‡πà‡∏¢‡∏ß</span>
        </button>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.5.13/cropper.min.js"></script>
    <script>
        // 1. ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡∏Å‡∏≤‡∏£‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠ GAS API (‡πÄ‡∏≠‡∏≤‡πÑ‡∏ß‡πâ‡∏ö‡∏ô‡∏™‡∏∏‡∏î‡πÄ‡∏•‡∏¢)
        const GAS_URL = "https://script.google.com/macros/s/AKfycbxTm1rBQFW7cgovS1uzgDLmIDEvqLgG6bdVV8vFMkNT4www9tglzjDihgbTNqv5KiqP/exec";

        // 2. ‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô Service Worker ‡πÉ‡∏´‡πâ‡πÅ‡∏≠‡∏õ‡πÇ‡∏´‡∏•‡∏î‡∏≠‡∏≠‡∏ü‡πÑ‡∏•‡∏ô‡πå‡πÑ‡∏î‡πâ
        if ('serviceWorker' in navigator) {
            navigator.serviceWorker.register('sw.js');
        }

        // 3. ‡∏ï‡∏±‡∏ß‡πÅ‡∏õ‡∏£‡∏Ç‡∏≠‡∏á‡∏£‡∏∞‡∏ö‡∏ö Canvas
        let cropper; let selectedBgColor = '#FFFFFF';
        let finalMaxQualityCanvases = []; let finalPrintQualityCanvases = []; 
        let singleVisaCanvasForExport = null; 
        
        let currentOrderId = "‡∏£‡∏≠‡∏£‡∏´‡∏±‡∏™..."; 
        let isOrderIdGenerated = false; 
        
        // --- 4. ‡∏£‡∏∞‡∏ö‡∏ö OFFLINE SYNC SYSTEM ---
        let offlineQueue = JSON.parse(localStorage.getItem('snapStudioQueue') || '[]');
        let localOrderCount = parseInt(localStorage.getItem('snapStudioOrderCount') || '0');
        let localLastDate = localStorage.getItem('snapStudioLastDate') || '';
        let isSyncing = false; // ‡∏ï‡∏±‡∏ß‡πÅ‡∏õ‡∏£‡∏•‡πá‡∏≠‡∏Å‡∏õ‡∏£‡∏∞‡∏ï‡∏π ‡∏Å‡∏±‡∏ô‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ã‡πâ‡∏≠‡∏ô‡∏Å‡∏±‡∏ô

        // 4.1 ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏Å‡∏•‡∏≤‡∏á‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÄ‡∏£‡∏µ‡∏¢‡∏Å API
        async function callGAS(methodName, extraData = {}) {
            const response = await fetch(GAS_URL, {
                redirect: 'follow', // ‡∏õ‡πâ‡∏≠‡∏á‡∏Å‡∏±‡∏ô‡∏ö‡∏±‡πä‡∏Å‡πÄ‡∏ß‡∏•‡∏≤ Google ‡∏™‡πà‡∏á Redirect
                method: 'POST',
                headers: { "Content-Type": "text/plain;charset=utf-8" },
                body: JSON.stringify({ method: methodName, ...extraData })
            });
            const result = await response.json();
            if (result.status === 'success') {
                if (result.data && result.data.success === false) {
                    throw new Error(result.data.error);
                }
                return result.data;
            }
            throw new Error(result.message);
        }

        // 4.2 ‡∏£‡∏∞‡∏ö‡∏ö‡∏î‡∏±‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏≠‡∏≠‡∏ü‡πÑ‡∏•‡∏ô‡πå
        async function syncOfflineQueue() {
            if (isSyncing || offlineQueue.length === 0 || !navigator.onLine) return;
            
            isSyncing = true; // ‡∏•‡πá‡∏≠‡∏Å‡∏õ‡∏£‡∏∞‡∏ï‡∏π
            const statusBadge = document.getElementById('networkStatus');
            
            try {
                while (offlineQueue.length > 0 && navigator.onLine) {
                    statusBadge.innerHTML = `üü¢ ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ã‡∏¥‡∏á‡∏Ñ‡πå... (‡πÄ‡∏´‡∏•‡∏∑‡∏≠ ${offlineQueue.length})`;
                    statusBadge.className = 'ml-3 px-2 py-0.5 text-[10px] font-bold rounded-full bg-blue-100 text-blue-700 border border-blue-200 shadow-sm';
                    
                    const dataToSync = offlineQueue[0];
                    await callGAS("processAction", { payload: dataToSync });
                    
                    offlineQueue.shift(); 
                    localStorage.setItem('snapStudioQueue', JSON.stringify(offlineQueue));
                }
            } catch(err) {
                console.error('‡∏Å‡∏≤‡∏£‡∏ã‡∏¥‡∏á‡∏Ñ‡πå‡∏Ç‡∏±‡∏î‡∏Ç‡πâ‡∏≠‡∏á ‡∏à‡∏∞‡∏•‡∏≠‡∏á‡πÉ‡∏´‡∏°‡πà‡∏†‡∏≤‡∏¢‡∏´‡∏•‡∏±‡∏á:', err);
            } finally {
                isSyncing = false; // ‡∏õ‡∏•‡∏î‡∏•‡πá‡∏≠‡∏Å‡∏õ‡∏£‡∏∞‡∏ï‡∏π
                updateNetworkStatus(); // ‡∏£‡∏µ‡πÄ‡∏ã‡πá‡∏ï‡∏´‡∏ô‡πâ‡∏≤‡∏à‡∏≠‡πÄ‡∏õ‡πá‡∏ô‡∏õ‡∏Å‡∏ï‡∏¥
            }
        }

        // 4.3 ‡∏£‡∏∞‡∏ö‡∏ö‡πÄ‡∏ä‡πá‡∏Ñ‡πÄ‡∏ô‡πá‡∏ï‡πÅ‡∏•‡∏∞‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏´‡∏ô‡πâ‡∏≤‡∏à‡∏≠
        function updateNetworkStatus() {
            const statusBadge = document.getElementById('networkStatus');
            if (navigator.onLine) {
                if (!isSyncing && offlineQueue.length === 0) {
                    statusBadge.innerHTML = 'üü¢ ‡∏≠‡∏≠‡∏ô‡πÑ‡∏•‡∏ô‡πå';
                    statusBadge.className = 'ml-3 px-2 py-0.5 text-[10px] font-bold rounded-full bg-green-100 text-green-700 border border-green-200 shadow-sm';
                }
                if (offlineQueue.length > 0) syncOfflineQueue();
            } else {
                statusBadge.innerHTML = `üî¥ ‡∏≠‡∏≠‡∏ü‡πÑ‡∏•‡∏ô‡πå (‡∏Ñ‡πâ‡∏≤‡∏á ${offlineQueue.length})`;
                statusBadge.className = 'ml-3 px-2 py-0.5 text-[10px] font-bold rounded-full bg-red-100 text-red-700 border border-red-200 shadow-sm';
            }
        }

        // 4.4 ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏•‡∏á‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏ï‡∏≠‡∏ô‡∏≠‡∏≠‡∏ü‡πÑ‡∏•‡∏ô‡πå
        function pushToOfflineQueue(payload) {
            offlineQueue.push(payload);
            localStorage.setItem('snapStudioQueue', JSON.stringify(offlineQueue));
            updateNetworkStatus();
        }

        window.addEventListener('online', updateNetworkStatus);
        window.addEventListener('offline', updateNetworkStatus);
        updateNetworkStatus(); // Run once on load
        // ---------------------------

        // 5. ‡∏£‡∏∞‡∏ö‡∏ö‡∏ï‡∏Å‡πÅ‡∏ï‡πà‡∏á‡∏£‡∏π‡∏õ (Canvas, Cropper, UI)
        const container = document.getElementById('eraser-container'); const canvas = document.getElementById('eraser-canvas'); const ctx = canvas.getContext('2d', { willReadFrequently: true });
        let isEraserActive = false; let isDrawing = false; let eraserHistory = []; let redoHistory = []; 
        let transform = { x: 0, y: 0, scale: 1 }; let isDragging = false; let dragStart = { x: 0, y: 0 };
        let initialPinchDistance = null; let initialScale = 1; let initialFocalPoint = { x: 0, y: 0 }; let initialTransform = { x: 0, y: 0 };

        function showLoader(text) { document.getElementById('loadingText').innerText = text; const overlay = document.getElementById('loadingOverlay'); overlay.classList.remove('hidden'); overlay.classList.add('flex'); }
        function hideLoader() { const overlay = document.getElementById('loadingOverlay'); overlay.classList.add('hidden'); overlay.classList.remove('flex'); }

        function getLogData(actionType) {
            const visaSelectValue = document.getElementById('visaSize').value;
            let size = "‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏";
            if(visaSelectValue === 'custom') { size = `${document.getElementById('customWidth').value}x${document.getElementById('customHeight').value}cm`; } 
            else { const opt = document.querySelector(`#visaSize option[value="${visaSelectValue}"]`); if(opt) size = opt.text; }
            return { orderId: currentOrderId, actionType: actionType, visaSize: size, totalFaces: document.getElementById('copies').value, paperUsed: finalPrintQualityCanvases.length || 0, timestampStr: new Date().toISOString() };
        }

        document.getElementById('viewSummaryBtn').addEventListener('click', async () => {
            document.getElementById('summaryModal').classList.remove('hidden');
            document.getElementById('summaryContent').innerHTML = '<p class="text-center text-gray-500 my-4 text-sm">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏≤‡∏Å Server...</p>';
            
            if (!navigator.onLine) {
                 document.getElementById('summaryContent').innerHTML = `<p class="text-center text-orange-500 my-4 font-bold">‚ö†Ô∏è ‡∏≠‡∏≠‡∏ü‡πÑ‡∏•‡∏ô‡πå‡∏≠‡∏¢‡∏π‡πà ‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏î‡∏π‡∏¢‡∏≠‡∏î‡πÄ‡∏£‡∏µ‡∏¢‡∏•‡πÑ‡∏ó‡∏°‡πå‡πÑ‡∏î‡πâ<br><span class="text-sm font-normal text-gray-500">‡∏°‡∏µ‡∏≠‡∏≠‡πÄ‡∏î‡∏≠‡∏£‡πå‡∏£‡∏≠‡∏ã‡∏¥‡∏á‡∏Ñ‡πå‡πÉ‡∏ô‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á ${offlineQueue.length} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</span></p>`;
                 return;
            }

            try {
                const summary = await callGAS("getTodaySummary");
                let html = `
                    <div class="grid grid-cols-2 gap-3 mb-2">
                        <div class="bg-blue-50 p-3 rounded-lg text-center border border-blue-100">
                            <span class="block text-xs text-blue-500 font-bold mb-1">‡∏ó‡∏≥‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</span>
                            <span class="text-2xl font-black text-blue-700">${summary.totalTransactions} <span class="text-sm font-normal text-blue-500">‡∏Ñ‡∏£‡∏±‡πâ‡∏á</span></span>
                        </div>
                        <div class="bg-green-50 p-3 rounded-lg text-center border border-green-100">
                            <span class="block text-xs text-green-500 font-bold mb-1">‡πÉ‡∏ä‡πâ‡∏Å‡∏£‡∏∞‡∏î‡∏≤‡∏©‡πÑ‡∏õ‡πÅ‡∏•‡πâ‡∏ß</span>
                            <span class="text-2xl font-black text-green-700">${summary.totalPaper} <span class="text-sm font-normal text-green-500">‡πÅ‡∏ú‡πà‡∏ô</span></span>
                        </div>
                    </div>
                    <ul class="text-sm text-gray-600 bg-gray-50 p-3 rounded-lg border border-gray-200 divide-y divide-gray-200">
                        <li class="py-2 flex justify-between"><span>üì≤ ‡πÅ‡∏ä‡∏£‡πå/‡πÄ‡∏ã‡∏ü ‡πÅ‡∏ú‡πà‡∏ô‡∏£‡∏ß‡∏°</span> <b>${summary.sheetSave} ‡∏≠‡∏≠‡πÄ‡∏î‡∏≠‡∏£‡πå</b></li>
                        <li class="py-2 flex justify-between"><span>üë§ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏£‡∏π‡∏õ‡πÄ‡∏î‡∏µ‡πà‡∏¢‡∏ß</span> <b>${summary.singleSave} ‡∏≠‡∏≠‡πÄ‡∏î‡∏≠‡∏£‡πå</b></li>
                        <li class="py-2 flex justify-between"><span>üì¶ ‡πÇ‡∏´‡∏•‡∏î‡πÑ‡∏ü‡∏•‡πå ZIP</span> <b>${summary.zip} ‡∏≠‡∏≠‡πÄ‡∏î‡∏≠‡∏£‡πå</b></li>
                    </ul>
                `;
                document.getElementById('summaryContent').innerHTML = html;
            } catch(err) {
                document.getElementById('summaryContent').innerHTML = '<p class="text-center text-red-500 my-4">‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à</p>';
            }
        });

        document.getElementById('closeSummaryBtn').addEventListener('click', () => { document.getElementById('summaryModal').classList.add('hidden'); });

        document.getElementById('globalRestartBtn').addEventListener('click', function() {
            const isPreviewVisible = !document.getElementById('preview-section').classList.contains('hidden');
            if (!isPreviewVisible && document.getElementById('imageInput').value !== '') { if (!confirm('‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ó‡∏≥‡∏£‡∏π‡∏õ‡πÉ‡∏´‡∏°‡πà‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡πÉ‡∏ä‡πà‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?')) return; }
            document.getElementById('preview-section').classList.add('hidden'); document.getElementById('step2-section').classList.add('hidden'); document.getElementById('step1-section').classList.remove('hidden'); document.getElementById('eraser-workspace').classList.add('hidden');
            document.getElementById('uploadArea').classList.remove('hidden'); 
            
            document.getElementById('imageInput').value = ''; ctx.clearRect(0, 0, canvas.width, canvas.height);
            ['brightness', 'contrast', 'rotation', 'temperature', 'softSkin'].forEach(id => document.getElementById(id).value = (id==='brightness'||id==='contrast')?100:0);
            document.getElementById('rotationValue').innerText = '0¬∞'; document.querySelector('.cropper-wrapper').appendChild(document.getElementById('smart-guide'));
            if(cropper) cropper.destroy(); window.scrollTo({ top: 0, behavior: 'smooth' }); 
            
            currentOrderId = "‡∏£‡∏≠‡∏£‡∏´‡∏±‡∏™..."; document.getElementById('displayOrderId').innerText = "‡∏£‡∏≠‡∏£‡∏´‡∏±‡∏™..."; isOrderIdGenerated = false;
        });

        document.getElementById('imageInput').addEventListener('change', function (e) {
            const file = e.target.files[0]; if (!file) return;
            const reader = new FileReader();
            reader.onload = function (event) {
                const img = new Image();
                img.onload = function() {
                    canvas.width = img.width; canvas.height = img.height; ctx.clearRect(0, 0, canvas.width, canvas.height); ctx.drawImage(img, 0, 0, canvas.width, canvas.height);
                    eraserHistory = []; redoHistory = []; saveHistory(); 
                    document.getElementById('eraser-workspace').classList.remove('hidden'); document.getElementById('uploadArea').classList.add('hidden'); fitCanvasToScreen(img.width, img.height);
                }; img.src = event.target.result;
            }; reader.readAsDataURL(file);
        });

        function fitCanvasToScreen(imgW, imgH) {
            const rect = container.getBoundingClientRect(); const w = imgW || canvas.width; const h = imgH || canvas.height;
            const scaleX = rect.width / w; const scaleY = rect.height / h; transform.scale = Math.min(scaleX, scaleY) * 0.9; 
            transform.x = (rect.width - (w * transform.scale)) / 2; transform.y = (rect.height - (h * transform.scale)) / 2; applyTransform();
        }
        document.getElementById('fitCanvasBtn').addEventListener('click', () => fitCanvasToScreen());
        function applyTransform() { canvas.style.transform = `translate(${transform.x}px, ${transform.y}px) scale(${transform.scale})`; }

        container.addEventListener('touchstart', handleTouchStart, { passive: false }); container.addEventListener('touchmove', handleTouchMove, { passive: false }); container.addEventListener('touchend', handleTouchEnd);
        container.addEventListener('mousedown', handleMouseDown); window.addEventListener('mousemove', handleMouseMove); window.addEventListener('mouseup', handleMouseUp); container.addEventListener('wheel', handleWheel, { passive: false });
        function getDistance(t) { const dx = t[0].clientX - t[1].clientX; const dy = t[0].clientY - t[1].clientY; return Math.sqrt(dx * dx + dy * dy); }
        function getMousePosOnCanvas(cx, cy) { const r = container.getBoundingClientRect(); return { x: (cx - r.left - transform.x) / transform.scale, y: (cy - r.top - transform.y) / transform.scale }; }

        function handleTouchStart(e) {
            if (e.touches.length >= 2) { isDrawing = false; isDragging = false; ctx.beginPath(); initialPinchDistance = Math.max(1, getDistance(e.touches)); initialScale = transform.scale;
                const r = container.getBoundingClientRect(); initialFocalPoint = { x: ((e.touches[0].clientX + e.touches[1].clientX) / 2) - r.left, y: ((e.touches[0].clientY + e.touches[1].clientY) / 2) - r.top }; initialTransform = { x: transform.x, y: transform.y }; e.preventDefault(); 
            } else if (e.touches.length === 1) {
                if (isEraserActive) { isDrawing = true; const pos = getMousePosOnCanvas(e.touches[0].clientX, e.touches[0].clientY); ctx.beginPath(); ctx.moveTo(pos.x, pos.y); } 
                else { isDragging = true; dragStart = { x: e.touches[0].clientX - transform.x, y: e.touches[0].clientY - transform.y }; } e.preventDefault(); 
            }
        }
        function handleTouchMove(e) {
            e.preventDefault();
            if (e.touches.length >= 2) { isDrawing = false; let ns = initialScale * (getDistance(e.touches) / initialPinchDistance); if (ns < 0.05) ns = 0.05; if (ns > 5) ns = 5;
                const r = container.getBoundingClientRect(); const cfp = { x: ((e.touches[0].clientX + e.touches[1].clientX) / 2) - r.left, y: ((e.touches[0].clientY + e.touches[1].clientY) / 2) - r.top };
                const asr = ns / initialScale; transform.scale = ns; transform.x = cfp.x - (initialFocalPoint.x - initialTransform.x) * asr; transform.y = cfp.y - (initialFocalPoint.y - initialTransform.y) * asr; applyTransform();
            } else if (e.touches.length === 1) {
                if (isDragging) { transform.x = e.touches[0].clientX - dragStart.x; transform.y = e.touches[0].clientY - dragStart.y; applyTransform(); } 
                else if (isDrawing && isEraserActive) { draw(e.touches[0].clientX, e.touches[0].clientY); }
            }
        }
        function handleTouchEnd(e) { if (isDrawing && isEraserActive) { ctx.beginPath(); saveHistory(); } isDrawing = false; isDragging = false; initialPinchDistance = null; }
        function handleMouseDown(e) { if (isEraserActive) { isDrawing = true; const pos = getMousePosOnCanvas(e.clientX, e.clientY); ctx.beginPath(); ctx.moveTo(pos.x, pos.y); } else { isDragging = true; dragStart = { x: e.clientX - transform.x, y: e.clientY - transform.y }; container.style.cursor = 'grabbing'; } }
        function handleMouseMove(e) { if (isDragging && !isEraserActive) { transform.x = e.clientX - dragStart.x; transform.y = e.clientY - dragStart.y; applyTransform(); } else if (isDrawing && isEraserActive) { draw(e.clientX, e.clientY); } }
        function handleMouseUp() { if (isDrawing && isEraserActive) { ctx.beginPath(); saveHistory(); } isDrawing = false; isDragging = false; if(!isEraserActive) container.style.cursor = 'grab'; }
        function handleWheel(e) { e.preventDefault(); const r = container.getBoundingClientRect(); const fx = e.clientX - r.left; const fy = e.clientY - r.top; let ns = transform.scale * (e.deltaY > 0 ? 0.9 : 1.1); if (ns < 0.05) ns = 0.05; if (ns > 5) ns = 5; const asr = ns / transform.scale; transform.x = fx - (fx - transform.x) * asr; transform.y = fy - (fy - transform.y) * asr; transform.scale = ns; applyTransform(); }
        function draw(clientX, clientY) {
            const pos = getMousePosOnCanvas(clientX, clientY); const brushRadius = (parseInt(document.getElementById('brushSize').value) / 2) * (canvas.width / 500); const softness = parseInt(document.getElementById('brushSoftness').value) * (canvas.width / 500);
            ctx.globalCompositeOperation = 'destination-out'; ctx.lineCap = 'round'; ctx.lineJoin = 'round'; ctx.lineWidth = brushRadius; ctx.shadowBlur = softness; ctx.shadowColor = 'rgba(0,0,0,1)';
            ctx.lineTo(pos.x, pos.y); ctx.stroke(); ctx.beginPath(); ctx.moveTo(pos.x, pos.y); ctx.shadowBlur = 0;
        }

        document.getElementById('toggleEraserBtn').addEventListener('click', () => {
            isEraserActive = !isEraserActive; const btn = document.getElementById('toggleEraserBtn'); const txt = document.getElementById('toggleEraserText');
            if(isEraserActive) { btn.classList.replace('bg-white', 'bg-blue-600'); btn.classList.replace('text-gray-700', 'text-white'); txt.innerText = "‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏•‡∏ö (‡πÅ‡∏ï‡∏∞‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏•‡∏ö)"; container.style.cursor = 'crosshair'; } 
            else { btn.classList.replace('bg-blue-600', 'bg-white'); btn.classList.replace('text-white', 'text-gray-700'); txt.innerText = "‡πÄ‡∏õ‡∏¥‡∏î‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡∏¢‡∏≤‡∏á‡∏•‡∏ö"; container.style.cursor = 'grab'; }
        });

        function saveHistory() { redoHistory = []; if (eraserHistory.length > 10) eraserHistory.shift(); eraserHistory.push(canvas.toDataURL()); }
        function loadCanvasFromDataURL(dataUrl) { const img = new Image(); img.onload = function() { ctx.globalCompositeOperation = 'source-over'; ctx.clearRect(0, 0, canvas.width, canvas.height); ctx.drawImage(img, 0, 0); }; img.src = dataUrl; }
        document.getElementById('undoBtn').addEventListener('click', function() { if (eraserHistory.length > 1) { redoHistory.push(eraserHistory.pop()); loadCanvasFromDataURL(eraserHistory[eraserHistory.length - 1]); }});
        document.getElementById('redoBtn').addEventListener('click', function() { if (redoHistory.length > 0) { const state = redoHistory.pop(); eraserHistory.push(state); loadCanvasFromDataURL(state); }});

        document.querySelectorAll('.color-btn').forEach(btn => {
            btn.addEventListener('click', function() { document.querySelectorAll('.color-btn').forEach(b => b.classList.remove('active')); this.classList.add('active'); selectedBgColor = this.getAttribute('data-color'); container.style.backgroundColor = selectedBgColor; container.style.backgroundImage = selectedBgColor === '#FFFFFF' ? "url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABAAAAAQCAYAAAAf8/9hAAAAMUlEQVQ4T2NkYNgfQMQgA2AklBwwiCEg0EhmGBqO0QxiwMhgNBwNx2gGDA8D1pAEAgA59xcBfR/hCQAAAABJRU5ErkJggg==')" : 'none'; });
        });
        document.getElementById('customColorPicker').addEventListener('input', function() { document.querySelectorAll('.color-btn').forEach(b => b.classList.remove('active')); selectedBgColor = this.value; container.style.backgroundColor = selectedBgColor; container.style.backgroundImage = 'none'; });

        function getSelectedVisaSize() {
            const v = document.getElementById('visaSize').value;
            if(v === 'custom') return { width: parseFloat(document.getElementById('customWidth').value)||4, height: parseFloat(document.getElementById('customHeight').value)||6 };
            const opt = document.querySelector(`#visaSize option[value="${v}"]`); return { width: parseFloat(opt.dataset.width), height: parseFloat(opt.dataset.height) };
        }
        document.getElementById('visaSize').addEventListener('change', function() { document.getElementById('customSizeContainer').classList.toggle('hidden', this.value !== 'custom'); if(cropper) { cropper.setAspectRatio(getSelectedVisaSize().width / getSelectedVisaSize().height); } });
        document.getElementById('customWidth').addEventListener('input', () => { if(cropper) cropper.setAspectRatio(getSelectedVisaSize().width/getSelectedVisaSize().height); });
        document.getElementById('customHeight').addEventListener('input', () => { if(cropper) cropper.setAspectRatio(getSelectedVisaSize().width/getSelectedVisaSize().height); });
        document.getElementById('toggleGuide').addEventListener('change', function() { document.getElementById('smart-guide').style.opacity = this.checked ? '0.6' : '0'; });

        function initCropperSetup() {
            if (cropper) cropper.destroy();
            const imgToCrop = document.getElementById('image-to-crop'); const size = getSelectedVisaSize();
            document.getElementById('rotation').value = 0; document.getElementById('rotationValue').innerText = '0¬∞'; document.getElementById('brightness').value = 100; document.getElementById('contrast').value = 100; document.getElementById('temperature').value = 0; document.getElementById('softSkin').value = 0;

            cropper = new Cropper(imgToCrop, {
                aspectRatio: size.width / size.height, viewMode: 1, dragMode: 'move', autoCropArea: 1.0, background: true, center: true, cropBoxMovable: false, cropBoxResizable: false, toggleDragModeOnDblclick: false,
                ready: function () {
                    document.querySelector('.cropper-container').style.backgroundColor = selectedBgColor; this.cropper.zoomTo(0); 
                    this.cropper.move(0, cropper.getContainerData().height * 0.02); 
                    document.querySelector('.cropper-view-box').appendChild(document.getElementById('smart-guide'));
                    updateFiltersPreview();
                }
            });
        }

        document.getElementById('toStep2Btn').addEventListener('click', function() {
            document.getElementById('step1-section').classList.add('hidden'); document.getElementById('step2-section').classList.remove('hidden');
            const paddedCanvas = document.createElement('canvas'); const tp = canvas.height * 0.2; paddedCanvas.width = canvas.width; paddedCanvas.height = canvas.height + tp; paddedCanvas.getContext('2d').drawImage(canvas, 0, tp);
            const imgToCrop = document.getElementById('image-to-crop'); imgToCrop.src = paddedCanvas.toDataURL('image/png'); imgToCrop.classList.remove('hidden');
            initCropperSetup(); window.scrollTo({ top: 0, behavior: 'smooth' });
        });

        document.getElementById('backToStep1Btn').addEventListener('click', function() { document.getElementById('step2-section').classList.add('hidden'); document.getElementById('step1-section').classList.remove('hidden'); document.querySelector('.cropper-wrapper').appendChild(document.getElementById('smart-guide')); window.scrollTo({ top: 0, behavior: 'smooth' }); });
        document.getElementById('resetCropBtn').addEventListener('click', function() { if(cropper) { cropper.reset(); cropper.zoomTo(0); cropper.move(0, cropper.getContainerData().height * 0.02); document.getElementById('rotation').value = 0; document.getElementById('rotationValue').innerText = '0¬∞'; cropper.rotateTo(0); }});

        function updateFiltersPreview() {
            const b = document.getElementById('brightness').value; const c = document.getElementById('contrast').value; const t = document.getElementById('temperature').value;
            let tempFilter = ''; if (t > 0) tempFilter = `sepia(${t/2}%) hue-rotate(-10deg) saturate(${100 + t/2}%)`; if (t < 0) tempFilter = `sepia(${Math.abs(t)/2}%) hue-rotate(180deg) saturate(${100 + Math.abs(t)/2}%)`; 
            const filterString = `brightness(${b}%) contrast(${c}%) ${tempFilter}`;
            if(document.querySelector('.cropper-view-box img')) { document.querySelector('.cropper-view-box img').style.filter = filterString; document.querySelector('.cropper-canvas img').style.filter = filterString; }
        }
        ['brightness', 'contrast', 'temperature', 'rotation'].forEach(id => { document.getElementById(id).addEventListener('input', function() { if(id === 'rotation') { cropper.rotateTo(parseFloat(this.value)); document.getElementById('rotationValue').innerText = (this.value > 0 ? '+' : '') + this.value + '¬∞'; } else { updateFiltersPreview(); } }); });

        document.getElementById('generateBtn').addEventListener('click', function() {
            if (!cropper) return;
            showLoader("‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏õ‡∏£‡∏∞‡∏°‡∏ß‡∏•‡∏ú‡∏•‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û...");
            setTimeout(() => {
                const croppedCanvas = cropper.getCroppedCanvas({ imageSmoothingEnabled: true, imageSmoothingQuality: 'high', fillColor: selectedBgColor });
                const finalCanvas = document.createElement('canvas'); finalCanvas.width = croppedCanvas.width; finalCanvas.height = croppedCanvas.height; const ctxF = finalCanvas.getContext('2d');
                ctxF.filter = `brightness(${document.getElementById('brightness').value}%) contrast(${document.getElementById('contrast').value}%)`; ctxF.drawImage(croppedCanvas, 0, 0); ctxF.filter = 'none'; 
                const temp = parseInt(document.getElementById('temperature').value);
                if (temp !== 0) { ctxF.globalCompositeOperation = 'overlay'; ctxF.globalAlpha = Math.abs(temp) / 100; ctxF.fillStyle = temp > 0 ? '#ffb04f' : '#2b80ff'; ctxF.fillRect(0, 0, finalCanvas.width, finalCanvas.height); ctxF.globalCompositeOperation = 'source-over'; ctxF.globalAlpha = 1.0; }
                const skin = parseInt(document.getElementById('softSkin').value);
                if (skin > 0) { const blurCanvas = document.createElement('canvas'); blurCanvas.width = finalCanvas.width; blurCanvas.height = finalCanvas.height; const bCtx = blurCanvas.getContext('2d'); bCtx.filter = `blur(${Math.max(2, finalCanvas.width/300)}px)`; bCtx.drawImage(finalCanvas, 0, 0); ctxF.globalAlpha = skin / 50; ctxF.drawImage(blurCanvas, 0, 0); ctxF.globalAlpha = 1.0; }
                
                singleVisaCanvasForExport = finalCanvas;
                generateLayouts(finalCanvas, "‡∏£‡∏≠‡∏Å‡∏≤‡∏£‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å...");
                hideLoader(); window.scrollTo({ top: 0, behavior: 'smooth' });
            }, 50);
        });

        function generateLayouts(visaImageCanvas, tempOrderId) {
            const CM_TO_INCH = 1 / 2.54; const pOpt = document.getElementById('paperSize').options[document.getElementById('paperSize').selectedIndex]; const size = getSelectedVisaSize(); 
            const pW = parseFloat(pOpt.dataset.width) * CM_TO_INCH; const pH = parseFloat(pOpt.dataset.height) * CM_TO_INCH;
            const vW = size.width * CM_TO_INCH; const vH = size.height * CM_TO_INCH;
            const copies = parseInt(document.getElementById('copies').value) || 1; const border = parseInt(document.getElementById('borderStyle').value); 

            finalPrintQualityCanvases = buildSheets(visaImageCanvas, pW, pH, vW, vH, copies, 300, border, tempOrderId);
            
            let maxSafeDPI = Math.max(300, visaImageCanvas.width / vW);
            if (pOpt.value === 'A4') maxSafeDPI = 300; 
            else if (maxSafeDPI > 600) maxSafeDPI = 600; 
            
            finalMaxQualityCanvases = buildSheets(visaImageCanvas, pW, pH, vW, vH, copies, maxSafeDPI, border, tempOrderId);

            const printArea = document.getElementById('print-area'); printArea.innerHTML = '';
            const maxPerSheet = Math.floor((pW - 0.4) / vW) * Math.floor((pH - 0.4) / vH);

            finalMaxQualityCanvases.forEach(cvs => {
                const wrapper = document.createElement('div'); wrapper.className = "watermark-wrapper w-full max-w-sm print:max-w-none"; 
                const overlay = document.createElement('div'); overlay.className = "watermark-overlay";
                const imgDisplay = document.createElement('img'); imgDisplay.src = cvs.toDataURL('image/jpeg', 0.6); imgDisplay.className = "w-full shadow-md bg-white border border-gray-300 print:shadow-none print:border-none";
                wrapper.appendChild(imgDisplay); wrapper.appendChild(overlay); printArea.appendChild(wrapper);
            });

            document.getElementById('calc-info').innerText = `‡∏£‡∏π‡∏õ‡∏Ç‡∏ô‡∏≤‡∏î ${size.width}x${size.height} ‡∏ã‡∏°. ‚Ä¢ ‡∏à‡∏±‡∏î‡πÑ‡∏î‡πâ ${maxPerSheet} ‡∏£‡∏π‡∏õ/‡πÅ‡∏ú‡πà‡∏ô ‚Ä¢ ‡∏£‡∏ß‡∏° ${finalMaxQualityCanvases.length} ‡πÅ‡∏ú‡πà‡∏ô`;
            document.getElementById('step2-section').classList.add('hidden'); document.getElementById('preview-section').classList.remove('hidden');
        }

        function buildSheets(imgCvs, pw, ph, vw, vh, copies, dpi, border, orderIdStr) {
            const pwPx = pw * dpi; const phPx = ph * dpi; const vwPx = vw * dpi; const vhPx = vh * dpi;
            const cols = Math.floor((pwPx - (dpi*0.4)) / vwPx); const rows = Math.floor((phPx - (dpi*0.4)) / vhPx);
            const max = cols * rows; let remaining = copies; let sheets = [];
            while (remaining > 0) {
                const cvs = document.createElement('canvas'); cvs.width = pwPx; cvs.height = phPx; const c = cvs.getContext('2d');
                c.fillStyle = '#ffffff'; c.fillRect(0, 0, pwPx, phPx);
                c.fillStyle = '#9ca3af'; c.font = `bold ${dpi * 0.08}px 'Kanit', sans-serif`; c.textAlign = 'right'; c.textBaseline = 'top'; 
                c.fillText("Snap&Print Studio | ID: " + orderIdStr, pwPx - (dpi * 0.1), dpi * 0.1); 

                let count = Math.min(remaining, max); let drawn = 0; const gap = dpi * 0.05; 
                const startX = (pwPx - ((cols * vwPx) + ((cols-1) * gap))) / 2; const startY = (phPx - ((rows * vhPx) + ((rows-1) * gap))) / 2;
                for (let r=0; r<rows; r++) {
                    for (let col=0; col<cols; col++) {
                        if (drawn < count) {
                            let x = startX + (col * vwPx) + (col * gap); let y = startY + (r * vhPx) + (r * gap);
                            c.imageSmoothingEnabled = true; c.imageSmoothingQuality = 'high'; c.drawImage(imgCvs, x, y, vwPx, vhPx);
                            if (border > 0) { c.strokeStyle = '#4b5563'; c.lineWidth = border * (dpi/300); c.strokeRect(x, y, vwPx, vhPx); }
                            drawn++;
                        }
                    }
                }
                sheets.push(cvs); remaining -= count;
            }
            return sheets;
        }

        async function executeActionWithOrder(actionName, callback) {
            if (isOrderIdGenerated) { logFinalAction(actionName); callback(); return; }
            showLoader("‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏™‡∏£‡πâ‡∏≤‡∏á Order ID ‡πÅ‡∏•‡∏∞‡∏à‡∏±‡∏î‡πÄ‡∏ï‡∏£‡∏µ‡∏¢‡∏°‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•...");

            if(navigator.onLine) {
                try {
                    const orderId = await callGAS("generateOrderId", { clientCount: localOrderCount });
                    const parts = orderId.split('-');
                    if (parts.length >= 4) {
                        const dateStr = parts.slice(0, 3).join('-');
                        const numPart = parseInt(parts[3], 10);
                        if (!isNaN(numPart)) {
                            localStorage.setItem('snapStudioOrderCount', numPart);
                            localStorage.setItem('snapStudioLastDate', dateStr);
                            localOrderCount = numPart;
                            localLastDate = dateStr;
                        }
                    }
                    currentOrderId = orderId; isOrderIdGenerated = true;
                    document.getElementById('displayOrderId').innerText = orderId; 
                    generateLayouts(singleVisaCanvasForExport, orderId);
                    logFinalAction(actionName);
                    hideLoader(); callback(); 
                } catch(err) {
                    fallbackLocalOrder(actionName, callback);
                }
            } else {
                fallbackLocalOrder(actionName, callback);
            }
        }

        function fallbackLocalOrder(actionName, callback) {
            const d = new Date();
            const year = d.getFullYear(); 
            const month = ("0" + (d.getMonth() + 1)).slice(-2); 
            const day = ("0" + d.getDate()).slice(-2);
            const todayStr = `${year}-${month}-${day}`;

            if (localLastDate !== todayStr) {
                localOrderCount = 0;
                localLastDate = todayStr;
                localStorage.setItem('snapStudioLastDate', todayStr);
            }

            localOrderCount++;
            localStorage.setItem('snapStudioOrderCount', localOrderCount);
            
            currentOrderId = `${todayStr}-${("000" + localOrderCount).slice(-3)} (‡∏≠‡∏≠‡∏ü‡πÑ‡∏•‡∏ô‡πå)`;
            
            isOrderIdGenerated = true;
            document.getElementById('displayOrderId').innerText = currentOrderId; 
            generateLayouts(singleVisaCanvasForExport, currentOrderId);
            logFinalAction(actionName); 
            hideLoader(); callback();
        }

        async function logFinalAction(actionName) { 
            const payload = getLogData(actionName);
            if(navigator.onLine) { 
                try {
                    await callGAS("processAction", { payload: payload });
                    console.log('Saved to cloud');
                } catch(err) {
                    pushToOfflineQueue(payload);
                }
            } else {
                pushToOfflineQueue(payload);
            }
        }

        document.getElementById('shareBtn').addEventListener('click', function() {
            const btn = this; const origBtnText = btn.innerHTML;
            executeActionWithOrder("‡πÅ‡∏ä‡∏£‡πå/‡πÄ‡∏ã‡∏ü ‡πÅ‡∏ú‡πà‡∏ô‡∏£‡∏ß‡∏°", async function() {
                btn.innerHTML = "‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÄ‡∏ï‡∏£‡∏µ‡∏¢‡∏°‡πÑ‡∏ü‡∏•‡πå..."; btn.disabled = true;
                const format = document.getElementById('exportFormat').value; const qualitySetting = document.getElementById('exportQuality').value;
                const canvasesToExport = qualitySetting === 'max' ? finalMaxQualityCanvases : finalPrintQualityCanvases;
                if (canvasesToExport.length === 0) { btn.innerHTML = origBtnText; btn.disabled = false; return; }
                const filesToShare = []; 

                try {
                    if (format === 'pdf') {
                        const { jsPDF } = window.jspdf; const w = canvasesToExport[0].width; const h = canvasesToExport[0].height;
                        const pdf = new jsPDF({ orientation: w > h ? 'landscape' : 'portrait', unit: 'px', format: [w, h] });
                        for (let i = 0; i < canvasesToExport.length; i++) {
                            if (i > 0) pdf.addPage([w, h], w > h ? 'landscape' : 'portrait');
                            pdf.addImage(canvasesToExport[i].toDataURL('image/jpeg', 1.0), 'JPEG', 0, 0, w, h);
                        }
                        filesToShare.push(new File([pdf.output('blob')], `${currentOrderId}.pdf`, { type: "application/pdf" }));
                    } else {
                        const mimeType = format === 'png' ? 'image/png' : 'image/jpeg'; const ext = format === 'png' ? 'png' : 'jpg';
                        for (let i = 0; i < canvasesToExport.length; i++) {
                            const blob = await new Promise(res => canvasesToExport[i].toBlob(res, mimeType, 1.0));
                            filesToShare.push(new File([blob], canvasesToExport.length > 1 ? `${currentOrderId}_Page${i+1}.${ext}` : `${currentOrderId}.${ext}`, { type: mimeType }));
                        }
                    }
                    if (navigator.canShare && navigator.canShare({ files: filesToShare })) { await navigator.share({ title: 'Snap&Print Visa', files: filesToShare }); } 
                    else { filesToShare.forEach(f => { const url = URL.createObjectURL(f); const a = document.createElement('a'); a.href = url; a.download = f.name; a.click(); URL.revokeObjectURL(url); }); }
                } catch (error) { alert("‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÑ‡∏ü‡∏•‡πå"); } finally { btn.innerHTML = origBtnText; btn.disabled = false; }
            });
        });

        document.getElementById('downloadZipBtn').addEventListener('click', function() {
            const btn = this; const origBtnText = btn.innerHTML;
            executeActionWithOrder("‡πÇ‡∏´‡∏•‡∏î‡πÅ‡∏û‡πá‡∏Å‡πÄ‡∏Å‡∏à (ZIP)", async function() {
                btn.innerHTML = "‡∏£‡∏≠‡∏™‡∏±‡∏Å‡∏Ñ‡∏£‡∏π‡πà..."; btn.disabled = true;
                if (finalMaxQualityCanvases.length === 0 || !singleVisaCanvasForExport) { btn.innerHTML = origBtnText; btn.disabled = false; return; }
                
                try {
                    const zip = new JSZip(); const { jsPDF } = window.jspdf;
                    const w = finalMaxQualityCanvases[0].width; const h = finalMaxQualityCanvases[0].height;
                    const pdf = new jsPDF({ orientation: w > h ? 'landscape' : 'portrait', unit: 'px', format: [w, h] });
                    for (let i = 0; i < finalMaxQualityCanvases.length; i++) {
                        if (i > 0) pdf.addPage([w, h], w > h ? 'landscape' : 'portrait');
                        pdf.addImage(finalMaxQualityCanvases[i].toDataURL('image/jpeg', 0.8), 'JPEG', 0, 0, w, h);
                    }
                    zip.file(`${currentOrderId}_Print.pdf`, pdf.output('blob'));
                    zip.file(`${currentOrderId}_HD.jpg`, await new Promise(res => singleVisaCanvasForExport.toBlob(res, 'image/jpeg', 1.0)));
                    
                    const webCanvas = document.createElement('canvas'); const maxSize = 800; 
                    let scale = 1; if(singleVisaCanvasForExport.width > maxSize || singleVisaCanvasForExport.height > maxSize) { scale = maxSize / Math.max(singleVisaCanvasForExport.width, singleVisaCanvasForExport.height); }
                    webCanvas.width = singleVisaCanvasForExport.width * scale; webCanvas.height = singleVisaCanvasForExport.height * scale;
                    const wCtx = webCanvas.getContext('2d'); wCtx.imageSmoothingEnabled = true; wCtx.imageSmoothingQuality = 'high'; wCtx.drawImage(singleVisaCanvasForExport, 0, 0, webCanvas.width, webCanvas.height);
                    zip.file(`${currentOrderId}_Web.jpg`, await new Promise(res => webCanvas.toBlob(res, 'image/jpeg', 0.7)));
                    
                    const content = await zip.generateAsync({type:"blob"}); const a = document.createElement("a"); a.href = URL.createObjectURL(content); a.download = `${currentOrderId}_Package.zip`; a.click(); URL.revokeObjectURL(a.href);
                } catch(e) { alert("‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÑ‡∏ü‡∏•‡πå ZIP"); } finally { btn.innerHTML = origBtnText; btn.disabled = false; }
            });
        });

        document.getElementById('saveSingleBtn').addEventListener('click', function() {
            const btn = this; const origBtnText = btn.innerHTML;
            executeActionWithOrder("‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏£‡∏π‡∏õ‡πÄ‡∏î‡∏µ‡πà‡∏¢‡∏ß", async function() {
                if (!singleVisaCanvasForExport) return;
                const blob = await new Promise(resolve => singleVisaCanvasForExport.toBlob(resolve, 'image/jpeg', 1.0));
                const file = new File([blob], `${currentOrderId}_Single.jpg`, { type: 'image/jpeg' });
                if (navigator.canShare && navigator.canShare({ files: [file] })) { await navigator.share({ title: 'Single Visa Photo', files: [file] }); } 
                else { const url = URL.createObjectURL(file); const a = document.createElement('a'); a.href = url; a.download = file.name; a.click(); URL.revokeObjectURL(url); }
            });
        });

        document.getElementById('backToStep2Btn').addEventListener('click', () => { 
            document.getElementById('preview-section').classList.add('hidden'); 
            document.getElementById('step2-section').classList.remove('hidden'); 
            window.scrollTo({ top: 0, behavior: 'smooth' }); 
        });

    </script>
</body>
</html>

